import RPi.GPIO as GPIO
import socket
import time
from threading import Thread

# ===== GPIO Pin Configuration =====
# IR Sensor Pins
IR_LEFT = 17      # BCM17 (Physical pin 11)
IR_MIDDLE = 27    # BCM27 (Physical pin 13)
IR_RIGHT = 22     # BCM22 (Physical pin 15)

# Motor A (Left Motor) Control Pins
IN1 = 23          # BCM23 (Physical pin 16)
IN2 = 24          # BCM24 (Physical pin 18)
ENA = 12          # BCM12 (Physical pin 32) - PWM capable

# Motor B (Right Motor) Control Pins
IN3 = 25          # BCM25 (Physical pin 22)
IN4 = 26          # BCM26 (Physical pin 37)
ENB = 13          # BCM13 (Physical pin 33) - PWM capable

# Server Configuration
SERVER_IP = "0.0.0.0"
SERVER_PORT = 5000

# ===== GPIO Setup =====
def setup_gpio():
    """Initialize GPIO pins"""
    GPIO.setmode(GPIO.BCM)
    GPIO.setwarnings(False)
    
    # Sensor inputs
    GPIO.setup(IR_LEFT, GPIO.IN)
    GPIO.setup(IR_MIDDLE, GPIO.IN)
    GPIO.setup(IR_RIGHT, GPIO.IN)
    
    # Motor control outputs
    GPIO.setup(IN1, GPIO.OUT)
    GPIO.setup(IN2, GPIO.OUT)
    GPIO.setup(IN3, GPIO.OUT)
    GPIO.setup(IN4, GPIO.OUT)
    
    # PWM setup for speed control
    global pwm_left, pwm_right
    pwm_left = GPIO.PWM(ENA, 1000)   # 1kHz frequency
    pwm_right = GPIO.PWM(ENB, 1000)  # 1kHz frequency
    
    pwm_left.start(0)
    pwm_right.start(0)
    
    print("✓ GPIO setup complete")

# ===== Motor Control Functions =====
def set_motor_speed(forward_speed, left_right_value):
    """
    Set motor speeds based on forward speed and steering
    forward_speed: -255 (backward) to 255 (forward)
    left_right_value: -100 (left) to 100 (right)
    """
    # Calculate individual motor speeds with steering
    # left_right_value: negative = turn left, positive = turn right
    
    # Base speeds from forward input
    left_motor_speed = forward_speed * (1 + left_right_value / 200)
    right_motor_speed = forward_speed * (1 - left_right_value / 200)
    
    # Clamp to valid range
    left_motor_speed = max(-255, min(255, left_motor_speed))
    right_motor_speed = max(-255, min(255, right_motor_speed))
    
    # Set left motor (Motor A)
    if left_motor_speed > 0:
        GPIO.output(IN1, GPIO.HIGH)
        GPIO.output(IN2, GPIO.LOW)
        pwm_left.ChangeDutyCycle(abs(left_motor_speed) / 2.55)
    elif left_motor_speed < 0:
        GPIO.output(IN1, GPIO.LOW)
        GPIO.output(IN2, GPIO.HIGH)
        pwm_left.ChangeDutyCycle(abs(left_motor_speed) / 2.55)
    else:
        GPIO.output(IN1, GPIO.LOW)
        GPIO.output(IN2, GPIO.LOW)
        pwm_left.ChangeDutyCycle(0)
    
    # Set right motor (Motor B)
    if right_motor_speed > 0:
        GPIO.output(IN3, GPIO.HIGH)
        GPIO.output(IN4, GPIO.LOW)
        pwm_right.ChangeDutyCycle(abs(right_motor_speed) / 2.55)
    elif right_motor_speed < 0:
        GPIO.output(IN3, GPIO.LOW)
        GPIO.output(IN4, GPIO.HIGH)
        pwm_right.ChangeDutyCycle(abs(right_motor_speed) / 2.55)
    else:
        GPIO.output(IN3, GPIO.LOW)
        GPIO.output(IN4, GPIO.LOW)
        pwm_right.ChangeDutyCycle(0)

def stop_motors():
    """Stop all motors"""
    GPIO.output(IN1, GPIO.LOW)
    GPIO.output(IN2, GPIO.LOW)
    GPIO.output(IN3, GPIO.LOW)
    GPIO.output(IN4, GPIO.LOW)
    pwm_left.ChangeDutyCycle(0)
    pwm_right.ChangeDutyCycle(0)

# ===== Server Functions =====
def handle_client(client_socket, client_address):
    """Handle incoming commands from laptop"""
    print(f"✓ Client connected: {client_address}")
    try:
        while True:
            data = client_socket.recv(1024).decode()
            if not data:
                break
            
            # Parse command: "FORWARD,LEFTRIGHT"
            try:
                parts = data.strip().split(',')
                forward_speed = int(parts[0])
                left_right_value = int(parts[1])
                
                set_motor_speed(forward_speed, left_right_value)
                print(f"Forward: {forward_speed:4d} | Left/Right: {left_right_value:4d}")
                
            except (ValueError, IndexError):
                print(f"✗ Invalid command: {data}")
    
    except Exception as e:
        print(f"✗ Error: {e}")
    finally:
        stop_motors()
        client_socket.close()
        print(f"✗ Client disconnected: {client_address}")

def start_server():
    """Start TCP server to receive commands"""
    server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    server_socket.bind((SERVER_IP, SERVER_PORT))
    server_socket.listen(1)
    
    print(f"✓ Server listening on {SERVER_IP}:{SERVER_PORT}")
    
    try:
        while True:
            client_socket, client_address = server_socket.accept()
            client_thread = Thread(target=handle_client, args=(client_socket, client_address))
            client_thread.daemon = True
            client_thread.start()
    
    except KeyboardInterrupt:
        print("\n✓ Shutting down server...")
    finally:
        stop_motors()
        server_socket.close()
        GPIO.cleanup()
        print("✓ Cleanup complete")

# ===== Main =====
if __name__ == "__main__":
    try:
        setup_gpio()
        start_server()
    except Exception as e:
        print(f"✗ Fatal error: {e}")
        GPIO.cleanup()
